<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AfterNote Admin - Verification Detail</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .header { background: #4a90d9; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; }
        .back-btn { color: white; text-decoration: none; font-weight: 600; }
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; padding: 24px; }
        .card h2 { color: #333; margin-bottom: 20px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        .info-item { }
        .info-label { color: #888; font-size: 13px; margin-bottom: 4px; }
        .info-value { color: #333; font-weight: 600; }
        .badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-approved { background: #d4edda; color: #155724; }
        .badge-rejected { background: #f8d7da; color: #721c24; }
        .document-section { margin-top: 20px; }
        .document-section h3 { color: #555; margin-bottom: 10px; }
        .document-link { display: inline-block; padding: 10px 20px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; color: #4a90d9; text-decoration: none; margin-right: 10px; margin-bottom: 10px; }
        .document-link:hover { background: #e9ecef; }
        .actions { margin-top: 30px; display: flex; gap: 12px; }
        .btn { padding: 12px 24px; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-approve { background: #28a745; color: white; }
        .btn-approve:hover { background: #218838; }
        .btn-reject { background: #dc3545; color: white; }
        .btn-reject:hover { background: #c82333; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .note-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 12px; font-size: 14px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .result-msg { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
        .result-success { background: #d4edda; color: #155724; }
        .result-error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Verification Detail</h1>
        <a href="/admin/verifications" class="back-btn">Back to List</a>
    </div>

    <div class="container">
        <div id="content">
            <p class="loading">Loading...</p>
        </div>
    </div>

    <script th:inline="javascript">
        const verificationId = /*[[${verificationId}]]*/ 0;

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        async function loadDetail() {
            const token = getCookie('accessToken');
            if (!token) {
                window.location.href = '/admin/login';
                return;
            }

            try {
                const response = await fetch(`/api/admin/verifications/${verificationId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/admin/login';
                    return;
                }

                const data = await response.json();
                const v = data.data;
                const isPending = v.status === 'PENDING';

                const badgeClass = v.status === 'APPROVED' ? 'badge-approved' : v.status === 'REJECTED' ? 'badge-rejected' : 'badge-pending';

                // Build DOM safely (no innerHTML for user data to prevent XSS)
                const container = document.getElementById('content');
                container.innerHTML = '';

                // Info card
                const infoCard = document.createElement('div');
                infoCard.className = 'card';
                const h2 = document.createElement('h2');
                h2.textContent = `Verification #${v.id}`;
                infoCard.appendChild(h2);

                const grid = document.createElement('div');
                grid.className = 'info-grid';
                function addInfoItem(label, value, isHtml) {
                    const item = document.createElement('div');
                    item.className = 'info-item';
                    const lbl = document.createElement('div');
                    lbl.className = 'info-label';
                    lbl.textContent = label;
                    const val = document.createElement('div');
                    val.className = 'info-value';
                    if (isHtml) { val.innerHTML = value; } else { val.textContent = value; }
                    item.appendChild(lbl);
                    item.appendChild(val);
                    grid.appendChild(item);
                }
                addInfoItem('Status', `<span class="badge ${badgeClass}">${v.status}</span>`, true);
                addInfoItem('Created', new Date(v.createdAt).toLocaleString('ko-KR'), false);
                addInfoItem('Sender', `${v.senderName || ''} (${v.senderEmail || ''})`, false);
                addInfoItem('Receiver', v.receiverName || '', false);
                infoCard.appendChild(grid);

                if (v.adminNote) {
                    addInfoItem('Admin Note', v.adminNote, false);
                }
                container.appendChild(infoCard);

                // Documents card
                const docCard = document.createElement('div');
                docCard.className = 'card';
                const docH2 = document.createElement('h2');
                docH2.textContent = 'Uploaded Documents';
                docCard.appendChild(docH2);
                ['Death Certificate', 'Family Relation Certificate'].forEach((title, i) => {
                    const section = document.createElement('div');
                    section.className = 'document-section';
                    const h3 = document.createElement('h3');
                    h3.textContent = title;
                    section.appendChild(h3);
                    const link = document.createElement('a');
                    link.href = i === 0 ? v.deathCertificateUrl : v.familyRelationCertificateUrl;
                    link.target = '_blank';
                    link.className = 'document-link';
                    link.textContent = 'View Document';
                    section.appendChild(link);
                    docCard.appendChild(section);
                });
                container.appendChild(docCard);

                // Action card (only for PENDING)
                if (isPending) {
                    const actCard = document.createElement('div');
                    actCard.className = 'card';
                    actCard.innerHTML = `<h2>Action</h2>
                        <input type="text" id="adminNote" class="note-input" placeholder="Admin note (optional)">
                        <div class="actions">
                            <button class="btn btn-approve" onclick="processVerification('approve')">Approve</button>
                            <button class="btn btn-reject" onclick="processVerification('reject')">Reject</button>
                        </div>
                        <div id="resultMsg" class="result-msg"></div>`;
                    container.appendChild(actCard);
                }
            } catch (error) {
                document.getElementById('content').innerHTML = '<p class="loading">Failed to load verification detail.</p>';
            }
        }

        async function processVerification(action) {
            const token = getCookie('accessToken');
            const adminNote = document.getElementById('adminNote')?.value || '';
            const resultMsg = document.getElementById('resultMsg');

            try {
                const response = await fetch(`/api/admin/verifications/${verificationId}/${action}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ adminNote })
                });

                const data = await response.json();

                if (response.ok) {
                    resultMsg.className = 'result-msg result-success';
                    resultMsg.textContent = `Verification ${action}d successfully.`;
                    resultMsg.style.display = 'block';
                    setTimeout(() => loadDetail(), 1500);
                } else {
                    resultMsg.className = 'result-msg result-error';
                    resultMsg.textContent = data.message || `Failed to ${action} verification.`;
                    resultMsg.style.display = 'block';
                }
            } catch (error) {
                resultMsg.className = 'result-msg result-error';
                resultMsg.textContent = 'Network error. Please try again.';
                resultMsg.style.display = 'block';
            }
        }

        loadDetail();
    </script>
</body>
</html>
