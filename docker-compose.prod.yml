services:
  # =========================================
  # 1. MySQL (운영 DB)
  # =========================================
  afternote-db:
    image: mysql:8.0
    container_name: afternote-db
    platform: linux/amd64
    restart: always
    environment:
      MYSQL_DATABASE: afternote
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: admin
      MYSQL_PASSWORD: password
      TZ: Asia/Seoul
    ports:
      - "3306:3306"
    volumes:
      - ./db_data:/var/lib/mysql
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 10

  # =========================================
  # 2. Redis (캐시/세션)
  # =========================================
  afternote-redis:
    image: redis:alpine
    container_name: afternote-redis
    ports:
      - "6379:6379"

  # =========================================
  # 3. Spring Boot (서버)
  # =========================================
  afternote-server:
    image: ${DOCKER_USERNAME}/afternote-server:latest
    container_name: afternote-server
    depends_on:
      afternote-db:
        condition: service_healthy
      afternote-redis:
        condition: service_started
    environment:
      SPRING_PROFILES_ACTIVE: prod
    env_file:
      - .env

  # =========================================
  # 4. Nginx (리버스 프록시 - HTTPS)
  # =========================================
  afternote-nginx:
    image: nginx:alpine
    container_name: afternote-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf # 프로덕션용 설정
      - ./data/certbot/conf:/etc/letsencrypt # SSL 인증서
      - ./data/certbot/www:/var/www/certbot # 인증서 갱신
    depends_on:
      - afternote-server

  # =========================================
  # 5. Certbot (SSL 인증서 자동 갱신)
  # =========================================
  afternote-certbot:
    image: certbot/certbot
    container_name: afternote-certbot
    volumes:
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
